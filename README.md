# 情報工学実験III 作業リポジトリ

情報工学実験IIIで扱うソフトウェアをチームで開発する作業リポジトリです。

## 開発ガイドライン

- `develop`ブランチには直接コミットしない（ブランチを切って作業しよう！）
- コミットメッセージには加えた変更を完結にわかりやすく書く

## 作業フロー

1. `develop`から`feature/xxxx`ブランチを切る
2. `feature/xxxx`内で機能開発を進める
3. 完成したら`develop`に向けてPull Requestを作成・レビュー依頼
4. 指摘された箇所を修正
5. Approve（承認）を貰ったら自分で`develop`にマージ

### 補足

- `feature/xxxx`の`xxxx`は適当な名前。何のタスクをやっているのか想像しやすい命名にしよう。例）`feature/line_trace_algorithm` など
- Pull Requestは作業完了前に作成しても構いません。互いにタスクの進み具合を把握するためにも、Pull Requestを発行した状態で作業を進めていくことを推奨します。

## 使用ツール

強制はしませんが、下記のツールを使用することを推奨します。

- JetBrains CLion (https://www.jetbrains.com/clion/)
- PlatformIO (https://platformio.org/)

Arduino IDEでも可能ではありますが、セットアップが面倒なので非推奨です。

## トラブルシューティング
- ヘッダーファイル内のインクルードにエラーが出てしまう。
    - `platformio init --board uno`を走らせてみてください。多分消えると思う。
    - 上記でも無理ならCLionのプロジェクトを再作成するとき、当プロジェクトのフォルダを選択した状態で、PlatformIOプロジェクト（Arduino Uno）を「Create from Existing Sources」すれば解消されるかも。

## アーキテクチャ

プログラムのアーキテクチャ・設計思想に関して説明します。（2022/12/13 最新のものに更新）

### ライフサイクル

#### setup関数

各種コンポーネントの初期化を行います。**インスタンス生成はここでしか行ってはいけません**。グローバル変数にはControllerクラスだけを置きます。
それ以外は基本的にグローバルスコープにおいてはいけません（デバッグ用クラスなどどうしても上に置くしかないものは例外）。

※以下のコードは簡略化したイメージです。実際のものとは一部異なります。

```c++
// コントローラーはloopで使うので一番上に宣言
CarController *controller;

void setup() {
    Car *car = new MyCar(
            new Motor(),
            new Motor(),
            new PhotoReflector(),
            new PhotoReflector(),
            new PhotoReflector()
    );
    controller = new MyCarController(car);
}
```

#### loop関数

各コンポーネントの状態を見て、車体を制御します。**インスタンス生成は原則として絶対にしてはいけません。** 電圧不足による予期しない挙動が発生します。

```c++
void loop() {
    controller->Operate();
    delay(10);
}
```

### クラス・インタフェース設計

#### `Car`（実体なし）

各コンポーネントを束ねるクラスです。渡さなければならない引数を一つにして、プログラムの保守性を向上させます。
コンストラクタで各コンポーネントのポインタを受け取って内部に保持し、メソッド経由でコンポーネントへのアクセスを公開します。
ハードウェアと1対1に対応します。

#### `CarController`インタフェース（用途に合わせ実装）

車体制御部を抽象化したものです。コンストラクタで制御対象の`Car`クラスのポインタを受け取り、保持。`Operate()`メソッド内で車体制御を行います。
以前はアルゴリズムの判断部(Brain)と車体制御命令(Instruction)に分離していましたが、これら2つを1箇所に結合しているイメージです。

#### `Motor`クラス

モータの制御用メソッドを提供します。

#### `Sensor`クラス

センサーの値更新・取得の機能を提供します。

#### その他クラス

センサーには様々な種類があるので、Sensorクラスを拡張して適宜機能追加をしていくといいと思います。

### アクティビティ図とクラス図

参考までに設計したアーキテクチャを簡単に示す図を紹介します。
#### アクティビティ図
<img src="https://user-images.githubusercontent.com/48154936/207234639-1f695bf1-f656-42a7-be8a-f1a5732ef955.png"/>

#### クラス図（仮）
<img src="https://user-images.githubusercontent.com/48154936/207234621-d91b4d2d-75ac-4974-814a-3b92a6a2b861.png" />


